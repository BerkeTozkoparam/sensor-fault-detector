# -*- coding: utf-8 -*-
"""App.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FJYWWY41rnS8wtYa1dMhwBbsw8ph2a3C
"""

# 1. Gerekli kÃ¼tÃ¼phaneleri yÃ¼kle
!pip install gradio

import gradio as gr
import joblib
import pandas as pd
import numpy as np

# 2. KayÄ±tlÄ± model ve encoder'Ä± yÃ¼kle
try:
    model = joblib.load('sensor_model_pipeline.joblib')
    le = joblib.load('label_encoder.joblib')
    class_names = le.classes_
    print("Model ve LabelEncoder baÅŸarÄ±yla yÃ¼klendi.")
except FileNotFoundError:
    print("HATA: Model (.joblib) dosyalarÄ± bulunamadÄ±. LÃ¼tfen Ã¶nce modeli eÄŸitin ve kaydedin.")
    model = None
    le = None

# 3. Dropdown menÃ¼ler iÃ§in seÃ§enekler
options = {
    'Operational Status': ['Operational', 'Under Maintenance'],
    'Maintenance Type': ['Corrective', 'Preventive'],
    'Failure History': ['Fault Detected', 'No Fault'],
    'External Factors': ['Clear Weather', 'Storm'],
    'Equipment Relationship': ['Dependent', 'Independent'],
    'Equipment Criticality': ['High', 'Medium']
}

# 4. Modeli Ã§alÄ±ÅŸtÄ±racak tahmin fonksiyonu (DÃ¶ndÃ¼rÃ¼len deÄŸer gÃ¼ncellendi)
def predict_failure_type(
    # 11 SayÄ±sal SÃ¼tun
    Voltage_V, Current_A, Temperature_C, Power_W, Humidity_Percent,
    Vibration_ms2, Ambient_Temperature_C, Ambient_Humidity_Percent,
    X, Y, Z,
    # 6 Kategorik SÃ¼tun
    Operational_Status, Maintenance_Type, Failure_History,
    External_Factors, Equipment_Relationship, Equipment_Criticality
):

    if model is None or le is None:
        return "Model yÃ¼klenemedi", pd.DataFrame({"Failure Type": ["Hata"], "Probability": [1.0]})

    # Gelen verileri modelin beklediÄŸi DataFrame'e dÃ¶nÃ¼ÅŸtÃ¼r
    input_df = pd.DataFrame([
        {
            "Voltage (V)": Voltage_V, "Current (A)": Current_A, "Temperature (Â°C)": Temperature_C,
            "Power (W)": Power_W, "Humidity (%)": Humidity_Percent, "Vibration (m/sÂ²)": Vibration_ms2,
            "Ambient Temperature (Â°C)": Ambient_Temperature_C, "Ambient Humidity (%)": Ambient_Humidity_Percent,
            "X": X, "Y": Y, "Z": Z, "Operational Status": Operational_Status,
            "Maintenance Type": Maintenance_Type, "Failure History": Failure_History,
            "External Factors": External_Factors, "Equipment Relationship": Equipment_Relationship,
            "Equipment Criticality": Equipment_Criticality
        }
    ])

    # Tahmin olasÄ±lÄ±klarÄ±nÄ± al
    probabilities = model.predict_proba(input_df)[0]

    # SÄ±nÄ±f isimleri ve olasÄ±lÄ±klarÄ± eÅŸleÅŸtir
    confidences = {class_names[i]: float(probabilities[i]) for i in range(len(class_names))}

    # En yÃ¼ksek olasÄ±lÄ±ÄŸa sahip tahmini bul
    prediction_label = class_names[np.argmax(probabilities)]

    # 1. Ã‡Ä±ktÄ±: Risk Durumu (Textbox iÃ§in)
    if prediction_label == 'None':
        risk_status = "âœ… DÃœÅÃœK RÄ°SK (ArÄ±za Tespit Edilmedi)"
    else:
        risk_status = f"ğŸ”¥ YÃœKSEK RÄ°SK (Tahmin: {prediction_label})"

    # 2. Ã‡Ä±ktÄ±: Grafik Verisi (BarPlot iÃ§in)
    # gr.BarPlot, DataFrame'i sever (Ã¶rn: [["None", 0.9], ["Overload", 0.1], ...])
    plot_data = pd.DataFrame(confidences.items(), columns=["Failure Type", "Probability"])

    # Ä°ki Ã§Ä±ktÄ± dÃ¶ndÃ¼r:
    return risk_status, plot_data

# 5. Gradio ArayÃ¼zÃ¼nÃ¼ TanÄ±mla (gr.Blocks ile)

# Ã–rnek veri
example_data = [
    112, 0.7, 22, 78.4, 42, 0.3, 22, 42, 2, 2, 2,
    "Operational", "Preventive", "No Fault", "Clear Weather", "Dependent", "High"
]

with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.Markdown("# ğŸ¤– Kestirimci BakÄ±m Modeli ArayÃ¼zÃ¼")
    gr.Markdown("SensÃ¶r verilerini girin ve arÄ±za tipini (None, Overload, Overheating) tahmin edin.")

    with gr.Row():
        # Ã‡Ä±ktÄ± BÃ¶lÃ¼mÃ¼ (GÃ¼ncellendi)
        with gr.Column(scale=1):
            gr.Markdown("## âš¡ï¸ Tahmin Sonucu")
            output_risk = gr.Textbox(label="Risk Durumu", interactive=False)

            # --- YENÄ° GRAFÄ°K BÄ°LEÅENÄ° ---
            # gr.Label'i gr.BarPlot ile deÄŸiÅŸtirdik
            output_plot = gr.BarPlot(
                label="Tahmin OlasÄ±lÄ±k DaÄŸÄ±lÄ±mÄ±",
                x="Failure Type",  # DataFrame'deki sÃ¼tun adÄ±
                y="Probability", # DataFrame'deki sÃ¼tun adÄ±
                y_lim=[0, 1],      # Y eksenini 0 ile 1 arasÄ±nda sabitle
                color="Failure Type", # SÃ¼tunlarÄ± sÄ±nÄ±f ismine gÃ¶re renklendir (Opsiyonel)
                vertical=True,   # Dikey Ã§ubuklar
                tooltip=["Failure Type", "Probability"] # Ãœzerine gelince gÃ¶ster
            )
            # -------------------------------

            submit_btn = gr.Button("Tahmin Et (Submit)", variant="primary")

        # Girdi BÃ¶lÃ¼mÃ¼ (DeÄŸiÅŸiklik yok)
        with gr.Column(scale=2):
            gr.Markdown("## ğŸ“Š SensÃ¶r Veri GiriÅŸi")
            with gr.Group():
                gr.Markdown("#### Temel SensÃ¶r Verileri")
                with gr.Row():
                    v = gr.Number(label="Voltage (V)", value=example_data[0])
                    c = gr.Number(label="Current (A)", value=example_data[1])
                    t = gr.Number(label="Temperature (Â°C)", value=example_data[2])
                with gr.Row():
                    p = gr.Number(label="Power (W)", value=example_data[3])
                    h = gr.Number(label="Humidity (%)", value=example_data[4])
                    vib = gr.Number(label="Vibration (m/sÂ²)", value=example_data[5])

            with gr.Group():
                gr.Markdown("#### Ekipman Durumu ve Ortam")
                with gr.Row():
                    op_status = gr.Dropdown(label="Operational Status", choices=options['Operational Status'], value=example_data[11])
                    maint_type = gr.Dropdown(label="Maintenance Type", choices=options['Maintenance Type'], value=example_data[12])
                    fail_hist = gr.Dropdown(label="Failure History", choices=options['Failure History'], value=example_data[13])
                with gr.Row():
                    ext_fact = gr.Dropdown(label="External Factors", choices=options['External Factors'], value=example_data[14])
                    equip_rel = gr.Dropdown(label="Equipment Relationship", choices=options['Equipment Relationship'], value=example_data[15])
                    equip_crit = gr.Dropdown(label="Equipment Criticality", choices=options['Equipment Criticality'], value=example_data[16])

            with gr.Group():
                gr.Markdown("#### DiÄŸer Veriler")
                with gr.Row():
                    amb_t = gr.Number(label="Ambient Temperature (Â°C)", value=example_data[6])
                    amb_h = gr.Number(label="Ambient Humidity (%)", value=example_data[7])
                with gr.Row():
                    x = gr.Number(label="X", value=example_data[8])
                    y = gr.Number(label="Y", value=example_data[9])
                    z = gr.Number(label="Z", value=example_data[10])

    # TÃ¼m giriÅŸ bileÅŸenlerini bir listeye topla
    inputs = [
        v, c, t, p, h, vib, amb_t, amb_h, x, y, z,
        op_status, maint_type, fail_hist, ext_fact, equip_rel, equip_crit
    ]

    # Ã‡Ä±ktÄ±larÄ± listele (GÃ¼ncellendi)
    outputs = [output_risk, output_plot]

    # Butona tÄ±klandÄ±ÄŸÄ±nda ne olacaÄŸÄ±nÄ± tanÄ±mla
    submit_btn.click(
        fn=predict_failure_type,  # Tahmin fonksiyonunu Ã§aÄŸÄ±r
        inputs=inputs,            # Bu girdilerle
        outputs=outputs           # Bu Ã§Ä±ktÄ±larÄ± gÃ¼ncelle
    )

    # Ã–rnek Veri Butonu (GÃ¼ncellendi)
    gr.Examples(
        examples=[example_data],
        inputs=inputs,
        outputs=outputs,
        fn=predict_failure_type,
        cache_examples=False
    )

# 6. ArayÃ¼zÃ¼ BaÅŸlat
print("GeliÅŸmiÅŸ Gradio arayÃ¼zÃ¼ (Grafik destekli) baÅŸlatÄ±lÄ±yor...")
demo.launch(share=True, debug=True)

